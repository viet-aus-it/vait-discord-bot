name: Build and deploy Docker Image

on:
  push:
    branches:
      - master
      - staging
    paths:
      - discord-bot/**
      - .github/workflows/build-and-deploy.yml

jobs:
  build-discord-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure SSH client
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat >> ~/.ssh/config <<END
          Host *
          ForwardAgent yes
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
          END
        env:
          SSH_KEY: ${{ secrets.SSH_KEY_EC2_CHATBOT }}

      - name: SSH to VAIT server
        run: |
          cmd="/usr/local/bin/deploy-chatbot ${SSH_USER} ${{ github.event.repository.name }} ${GITHUB_REF##*/} /${{ github.event.repository.name }}/discord-bot/.env.docker.${GITHUB_REF##*/},discord-bot,.env.docker /${{ github.event.repository.name }}/discord-bot/.env.${GITHUB_REF##*/},discord-bot,.env"
          ssh ${SSH_USER}@${SSH_HOST} "${cmd}"
        env:
          SSH_USER: ${{ secrets.SSH_USER_EC2_CHATBOT }}
          SSH_HOST: ${{ secrets.SSH_HOST_EC2_CHATBOT }}

      - name: Remove SSH Key
        run: rm ~/.ssh/id_rsa
